<!DOCTYPE html>
<html lang="it">
  <head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Language" content="en">
    <meta name="viewport" content="width=device-width">
    <title>Sondaggio per il bando Art Bonus</title>

    <!-- Material Design Theming -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

    <link rel="stylesheet" href="main.css">

    <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyBar-9m_Rvz10JdMm4veVLUUPRUcBT5Etw",
        authDomain: "art-bonus-survey-desio.firebaseapp.com",
        databaseURL: "https://art-bonus-survey-desio.firebaseio.com",
        storageBucket: "art-bonus-survey-desio.appspot.com",
      };
      firebase.initializeApp(config);
    </script>

    <script>
      var accountDetails = null;

      function voteFlow(project) {
        disableVoteButtons();
        enableLoading(project);
        vote(project).then(function() {
          disableLoading(project);
          highlightResult(project);
        }).catch(function(error) {
          console.debug("errore:", error);
        });
      }

      function getUserdata() {
        return accountDetails;
      };

      function disableVoteButtons() {
        document.getElementById("vote-project-1").disabled = true;
        document.getElementById("vote-project-2").disabled = true;
        document.getElementById("vote-project-3").disabled = true;
      }

      function disableLoading(project) {
        switch (project) {
          case "project-1":
            document.getElementById("vote-1-progress").classList.add("hide");
            break;
          case "project-2":
            document.getElementById("vote-2-progress").classList.add("hide");
            break;
          case "project-3":
            document.getElementById("vote-3-progress").classList.add("hide");
            break;
          default:
            // TODO: handle error
        }
      };

      function enableLoading(project) {
        switch (project) {
          case "project-1":
            document.getElementById("vote-1-progress").classList.remove("hide");
            break;
          case "project-2":
            document.getElementById("vote-2-progress").classList.remove("hide");
            break;
          case "project-3":
            document.getElementById("vote-3-progress").classList.remove("hide");
            break;
          default:
            // TODO: handle error
        }
      }

      function highlightResult(project) {
        switch (project) {
          case "project-1":
            document.querySelector("#vote-project-1 .material-icons").classList.remove("hide");
            document.querySelector(".vote-result--1").classList.remove("hide");
            break;
          case "project-2":
            document.querySelector("#vote-project-2 .material-icons").classList.remove("hide");
            document.querySelector(".vote-result--2").classList.remove("hide");
            break;
          case "project-3":
            document.querySelector("#vote-project-3 .material-icons").classList.remove("hide");
            document.querySelector(".vote-result--3").classList.remove("hide");
            break;
          default:
            // TODO: handle error
        }
      }

      function vote(project) {
        var voteData = {
            user: getUserdata(),
            project: project,
        };
        var newVoteKey = firebase.database().ref().child('votes').push().key;
        var updates = {};
        updates['/votes/' + newVoteKey] = voteData;

        return firebase.database().ref().update(updates);
      };

      function toggleSignIn(providerName) {
        if (!firebase.auth().currentUser) {

          var provider = null;
          switch (providerName) {
            case "facebook":
              provider = new firebase.auth.FacebookAuthProvider();
              document.getElementById('quickstart-sign-in--google').classList.add("hide");
              document.getElementById('quickstart-sign-in--twitter').classList.add("hide");
              break;
            case "google":
              provider = new firebase.auth.GoogleAuthProvider();
              document.getElementById('quickstart-sign-in--facebook').classList.add("hide");
              document.getElementById('quickstart-sign-in--twitter').classList.add("hide");
            break;
            case "twitter":
              provider = new firebase.auth.TwitterAuthProvider();
              document.getElementById('quickstart-sign-in--facebook').classList.add("hide");
              document.getElementById('quickstart-sign-in--google').classList.add("hide");
              break;
            default:
              // error
              // TODO
          }
          firebase.auth().signInWithRedirect(provider);
        } else {
          firebase.auth().signOut();
          document.getElementById('quickstart-sign-in--facebook').classList.remove("hide");
          document.getElementById('quickstart-sign-in--google').classList.remove("hide");
          document.getElementById('quickstart-sign-in--twitter').classList.remove("hide");

          document.getElementById('vote-project-1').disabled = true;
          document.getElementById('vote-project-2').disabled = true;
          document.getElementById('vote-project-3').disabled = true;
        }
        document.getElementById('quickstart-sign-in--facebook').disabled = true;
        document.getElementById('quickstart-sign-in--google').disabled = true;
        document.getElementById('quickstart-sign-in--twitter').disabled = true;
      }

      function initApp() {
        firebase.auth().getRedirectResult().then(function(result) {
          var user = result.user;
        }).catch(function(error) {
          var errorCode = error.code;
          var errorMessage = error.message;
          var email = error.email;
          var credential = error.credential;
          if (errorCode === 'auth/account-exists-with-different-credential') {
            alert('You have already signed up with a different auth provider for that email.');
          } else {
            // TODO: handle this case
            console.error(error);
          }
        });
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            var displayName = user.displayName;
            var email = user.email;
            var emailVerified = user.emailVerified;
            var photoURL = user.photoURL;
            var isAnonymous = user.isAnonymous;
            var uid = user.uid;
            var refreshToken = user.refreshToken;
            var providerData = user.providerData;

            document.getElementById('quickstart-sign-in-status').textContent = 'Autenticato.';
            document.getElementById('quickstart-sign-in--facebook').textContent = 'Scollega da Facebook';
            document.getElementById('quickstart-sign-in--google').textContent = 'Scollega da Google';
            document.getElementById('quickstart-sign-in--twitter').textContent = 'Scollega da Twitter';


            switch (providerData[0].providerId) {
              case "facebook.com":
                document.getElementById('quickstart-sign-in--google').classList.add("hide");
                document.getElementById('quickstart-sign-in--twitter').classList.add("hide");
                break;
              case "twitter.com":
                document.getElementById('quickstart-sign-in--google').classList.add("hide");
                document.getElementById('quickstart-sign-in--facebook').classList.add("hide");
                break;
              case "google.com":
                document.getElementById('quickstart-sign-in--facebook').classList.add("hide");
                document.getElementById('quickstart-sign-in--twitter').classList.add("hide");
                break;
              default:
            }

            // debug only: not used
            accountDetails = {
              displayName: displayName,
              email: email,
              emailVerified: emailVerified,
              photoURL: photoURL,
              isAnonymous: isAnonymous,
              uid: uid,
              refreshToken: refreshToken,
              providerData: providerData
            };
            document.getElementById('vote-project-1').disabled = false;
            document.getElementById('vote-project-2').disabled = false;
            document.getElementById('vote-project-3').disabled = false;
          } else {
            accountDetails = null;
            document.getElementById('quickstart-sign-in-status').textContent = 'Non autenticato.';
            document.getElementById('quickstart-sign-in--facebook').textContent = 'Facebook';
            document.getElementById('quickstart-sign-in--google').textContent = 'Google';
            document.getElementById('quickstart-sign-in--twitter').textContent = 'Twitter';

            document.getElementById('vote-project-1').disabled = true;
            document.getElementById('vote-project-2').disabled = true;
            document.getElementById('vote-project-3').disabled = true;
          }
          document.getElementById('quickstart-sign-in--facebook').disabled = false;
          document.getElementById('quickstart-sign-in--google').disabled = false;
          document.getElementById('quickstart-sign-in--twitter').disabled = false;
        });
        document.getElementById('quickstart-sign-in--facebook').addEventListener('click', function(event) {
          event.preventDefault();
          toggleSignIn("facebook");
          return false;
        }, false);
        document.getElementById('quickstart-sign-in--google').addEventListener('click', function(event) {
          event.preventDefault();
          toggleSignIn("google");
          return false;
        }, false);
        document.getElementById('quickstart-sign-in--twitter').addEventListener('click', function(event) {
          event.preventDefault();
          toggleSignIn("twitter");
          return false;
        }, false);

        document.getElementById('vote-project-1').addEventListener('click', function(event) {
          event.preventDefault();
          voteFlow("project-1");
          return false;
        }, false);

        document.getElementById('vote-project-2').addEventListener('click', function(event) {
          event.preventDefault();
          voteFlow("project-2");
          return false;
        }, false);

        document.getElementById('vote-project-3').addEventListener('click', function(event) {
          event.preventDefault();
          voteFlow("project-3");
          return false;
        }, false);
      }
      window.onload = function() {
        initApp();
      };
    </script>
  </head>
  <body>
    <div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">

      <!-- Header section containing title -->
      <header class="mdl-layout__header mdl-color-text--white mdl-color--light-blue-700">
        <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">
          <div class="mdl-layout__header-row mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--8-col-desktop">
            <a href="/"><h3>Sondaggio per la scelta del progetto "Art Bonus"</h3></a>
          </div>
        </div>
      </header>

      <main class="mdl-layout__content mdl-color--grey-100">
        <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">

          <!-- Container for the demo -->
          <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">
            <div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white">
              <h2 class="mdl-card__title-text">1. Autenticazione (necessaria per poter votare)</h2>
            </div>
            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
              <p>Servizi disponibili:</p>

              <!-- Button that handles sign-in/sign-out -->
              <button disabled class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-sign-in--facebook">Facebook</button>
              <button disabled class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-sign-in--google">Google</button>
              <button disabled class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-sign-in--twitter">Twitter</button>

              <!-- Container where we'll display the user details -->

              <div class="quickstart-user-details-container">
                Stato: <span id="quickstart-sign-in-status">...</span>
              </div>
            </div>
          </div>

          <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--4-col-desktop">
            <div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white">
              <h2 class="mdl-card__title-text">Progetto 1</h2>
            </div>

            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
              <img class="project-image" src="http://dummyimage.com/200x200/000/fff.jpg&text=progetto+1" />

              <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>


              <button disabled class="button--vote mdl-button mdl-js-button mdl-button--raised" id="vote-project-1">
                Vota questo progetto<i class="material-icons hide">&#xE876;</i>
              </button>

              <div id="vote-1-progress" class="vote-progress-loading-bar mdl-progress mdl-js-progress mdl-progress__indeterminate hide"></div>

              <p class="vote-result--voted vote-result--1 hide">
                Hai votato!
              </p>

            </div>
          </div>

          <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--4-col-desktop">
            <div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white">
              <h2 class="mdl-card__title-text">Progetto 2</h2>
            </div>

            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
              <img class="project-image" src="http://dummyimage.com/200x200/000/fff.jpg&text=progetto+2" />

              <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>


              <button disabled class="button--vote mdl-button mdl-js-button mdl-button--raised" id="vote-project-2">
                Vota questo progetto <i class="material-icons hide">&#xE876;</i>
              </button>

              <div id="vote-2-progress" class="vote-progress-loading-bar mdl-progress mdl-js-progress mdl-progress__indeterminate hide"></div>

              <p class="vote-result--voted vote-result--2 hide">
                Hai votato!
              </p>

            </div>
          </div>

          <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--4-col-desktop">
            <div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white">
              <h2 class="mdl-card__title-text">Progetto 3</h2>
            </div>

            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
              <img class="project-image" src="http://dummyimage.com/200x200/000/fff.jpg&text=progetto+3" />

              <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>


              <button disabled class="button--vote mdl-button mdl-js-button mdl-button--raised" id="vote-project-3">
                Vota questo progetto <i class="material-icons hide">&#xE876;</i>
              </button>

              <div id="vote-3-progress" class="vote-progress-loading-bar mdl-progress mdl-js-progress mdl-progress__indeterminate hide"></div>

              <p class="vote-result--voted vote-result--3 hide">
                Hai votato!
              </p>

            </div>
          </div>

        </div>
      </main>
    </div>
  </body>
</html>
